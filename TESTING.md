# Testing Guide

This document explains how to set up and run the IrysSDK test suite locally and in CI/CD environments.

## Local Development Setup

### Prerequisites

- .NET 8.0 SDK or later
- No additional tools required (automatic environment loading)

### Step 1: Create Local Environment File

Copy the example environment file to create your local configuration:

```powershell
Copy-Item .env.example .env.local
```

### Step 2: Update Credentials

Edit `.env.local` with your test credentials:

```
IRYS_TEST_EMAIL=your-test-email@example.com
IRYS_TEST_PASSWORD=your-test-password
```

**Note:** The `.env.local` file is git-ignored and will not be committed to the repository.

### Step 3: Run Tests

That's it! Just run the test suite and .env.local is automatically loaded:

```powershell
dotnet test
```

The fixture automatically loads your credentials from `.env.local` when tests start.

## Running Tests in GitHub Actions

### Step 1: Add Repository Secrets

In your GitHub repository settings, add two secrets:

1. **IRYS_TEST_EMAIL**
   - Go to Settings → Secrets and variables → Actions
   - Click "New repository secret"
   - Name: `IRYS_TEST_EMAIL`
   - Value: Your test email address

2. **IRYS_TEST_PASSWORD**
   - Click "New repository secret"
   - Name: `IRYS_TEST_PASSWORD`
   - Value: Your test password

### Step 2: GitHub Actions Workflow

The workflow file `.github/workflows/test.yml` automatically:

1. Checks out your code
2. Sets up .NET 8.0
3. Restores dependencies
4. Builds the solution
5. Runs all tests with credentials injected from repository secrets

The secrets are automatically converted to environment variables within the Actions workflow and injected into the test process.

**Important:** Secrets are never logged to the Actions output. The workflow masks their values automatically.

## Test Architecture

Tests use the following patterns for credential management:

### Automatic Environment Loading

The `SdkFixture` class automatically loads credentials from `.env.local` at runtime:

1. **First check**: Are environment variables already set? (GitHub Actions uses this)
   - If yes, use those values
   - If no, continue to next step

2. **Second check**: Does `.env.local` file exist?
   - If yes, read and load environment variables from it
   - If no, tests cannot proceed

This approach provides:
- **Local Development**: Credentials from `.env.local` file (no manual steps needed)
- **GitHub Actions**: Credentials from repository secrets (overrides .env.local)

### Shared Fixture Pattern

All test classes share a single authenticated SDK instance via the `[Collection]` attribute:

```csharp
[Collection("SDK Collection")]
public class SurveyTests : IClassFixture<SdkFixture>
{
    // All tests in this class share the same authenticated SdkFixture
}
```

This provides:
- Single login per test run (efficient)
- Shared `AuthenticatedUserId` for user-dependent operations
- Consistent test data context


## Test Organization

- **Tests are located in:** `IrysSDK.Tests/`
- **Fixtures in:** `IrysSDK.Tests/Fixtures/`
- **Run all tests:** `dotnet test`
- **Run specific class:** `dotnet test --filter ClassName`
- **View verbose output:** `dotnet test --verbosity detailed`

## Schema Validation

The OpenAPI specification (`IrysSDK/openapi.yml`) is validated against actual API responses:

- Schema is auto-generated by NSwag from the OpenAPI spec
- All field types and nullability constraints are based on HAR file analysis
- Tests validate that real API responses deserialize correctly against the schema

## Troubleshooting

### Tests don't run locally

**Issue:** Tests fail with authentication errors

**Checklist:**
1. Verify `.env.local` file exists in the solution root
2. Verify `.env.local` contains `IRYS_TEST_EMAIL` and `IRYS_TEST_PASSWORD`
3. Verify credentials in `.env.local` are correct
4. Run `dotnet clean` and `dotnet build` to rebuild
5. If still failing, check the test output for which credentials are being used

**Alternative - Set environment variables manually:**
```powershell
$env:IRYS_TEST_EMAIL = "your-email@example.com"
$env:IRYS_TEST_PASSWORD = "your-password"
dotnet test
```

When environment variables are set via PowerShell, the fixture uses those instead of .env.local (CI/local override takes precedence).

### GitHub Actions tests failing with "unauthorized" errors

**Issue:** Secrets not passed correctly to workflow

**Verify:**
1. Go to Settings → Secrets and variables → Actions
2. Confirm both `IRYS_TEST_EMAIL` and `IRYS_TEST_PASSWORD` are present
3. Review the workflow file `.github/workflows/test.yml` shows `env:` section with secret references
4. Re-run the workflow after confirming secrets

### Authentication errors in tests

**Issue:** Invalid test credentials

**Solution:**
1. Verify credentials in `.env.local` (local dev) are correct
2. Verify repository secrets (GitHub Actions) are correct
3. Test credentials separately using the SDK directly
4. Contact your IrysSDK administrator for credentials

## Security Notes

- ✅ `.env.local` is git-ignored and never committed
- ✅ GitHub Actions secrets are masked in logs automatically
- ✅ No credentials are hardcoded in source files
- ⚠️ Never commit `.env.local` or actual credentials to the repository
- ⚠️ Never share repository secrets publicly

## Further Documentation

- [GitHub Actions Secrets Documentation](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [xUnit Fixtures Documentation](https://xunit.net/docs/shared-context)
- [NSwag API Code Generation](https://github.com/RicoSuter/NSwag)
